# 雪花算法简述

##### 一、引子

在使用雪花算法生成分布式全局ID的时候，出现了重复的id，什么？不是说好的唯一吗？

##### 二、原理

1. 雪花算法定义了时间戳，机器标识和序列号等来保证生成id的唯一性
2. 机器标识可以设置机房位数，具体机器位数等
3. 每一次生成id后，都会保存当前时间戳
4. 每次生成id时，都会校验时间戳，如果当前时间戳小于上一次生成id的时间戳，那肯定是机器时间出了问题
5. 如果当前时间和上次生成id的时间戳不一样，序列号默认用最小的就行，因为时间戳保证id不会重复了
6. 如果当前时间和上次生成id时间相同，就给序列号加1
7. 如果并发量大，同一个时间戳创建的id数量大于最大序列号，即序列号不够用的情况，时间戳阻塞到下一毫秒，序列号重置到最小

##### 三、优缺点分析

1. 优点：
   1. 生成的id趋势递增，相比uuid更适合加索引
   2. 性能较高
2. 缺点：
   1. 如果机器时间回退，可能出现重复的id
   2. 如果设置机器标识是根据ip来设置的，可能出现重复的id