# 分布式锁的几点思考

#### 一、什么是锁

锁就是某个资源在同一时间只允许一个线程操作。

#### 二、Redis锁

1. 设置一个唯一的key，当这个key存在在redis时候，证明锁被抢了，其他线程获取锁失败。
2. 当处理完业务逻辑后，需要释放锁，为了防止释放错误的锁，可以在存入redis的时候，value设置为一个唯一的随机值，释放锁的时候判断获取的value是不是等于存入的value。
3. 抢占锁失败后，根据业务需求，可以直接返回错误等，也可以继续竞争锁，竞争锁也可以设置一个固定时间，超过这个时间就不再竞争。
4. 设置redis的过期时间，防止死锁。

#### 三、数据库锁

1. 新建一个锁表，获取锁的时候，就插入一条数据（某个列增加唯一约束），释放锁的时候，就将该条记录删除。缺点是不能设置失效时间，需要定期清理未正常释放的锁；这种方法与redis锁类似。
2. 基于版本号实现乐观锁，也可以直接用时间戳：首先查询某条数据的版本号oldVersion，进行业务操作，最后在做更新的时候检查版本号，即where条件后面加上校验 version=oldVersion。
3. 悲观锁，select * from ...where ... for update，执行业务逻辑，最后提交。注意点：需要关闭数据库自动提交属性；明确指定主键或者索引，使用行锁，防止表锁；容易阻塞，可用性低。

#### 四、zookeeper锁